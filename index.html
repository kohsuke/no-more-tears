<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">










<html>
  <head>
    <title>No More Tears - </title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/1024px.css");
      @import url("./css/site.css");
    </style>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      </head>
  <body>
    <div id="wrap2"><div id="wrap">
    <div id="header">
      <p id="toplinks">Skip to: <a href="#content">Content</a> | <a href="#sidebar">Navigation</a> | <a href="#footer">Footer</a></p>
		
            <h1 id="bannerLeft">
          <a href="http://no-more-tears.kohsuke.org/">
    
            No More Tears
    
            </a>
        </h1>
                
      <p id="slogan">Defer the resolution of symbols to runtime with invokeDynamic</p>
    </div>
    <div id="breadcrumbs">
      <div class="xright">  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>

    <div id="sidebar">
      <div id="navcolumn">
              <h2>
          No More Tears
        </h2><ul>
              
    <li class="none">
              <strong>Introduction</strong>
        </li>
              
    <li class="none">
              <a href="https://github.com/kohsuke/no-more-tears">Source code</a>
        </li>
          </ul>
      <h2>
          References
        </h2><ul>
              
    <li class="none">
              <a href="apidocs/index.html">Javadoc</a>
        </li>
          </ul>
      <h2>
          Project Documentation
        </h2><ul>
              
                
              
            
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
            
      
              
            <li class="expanded">
              <a href="project-info.html">Project Information</a>
                <ul>
                  
    <li class="none">
              <strong>About</strong>
        </li>
                  
    <li class="none">
              <a href="integration.html">Continuous Integration</a>
        </li>
                  
    <li class="none">
              <a href="dependencies.html">Dependencies</a>
        </li>
                  
    <li class="none">
              <a href="dependency-convergence.html">Dependency Convergence</a>
        </li>
                  
    <li class="none">
              <a href="dependency-info.html">Dependency Information</a>
        </li>
                  
    <li class="none">
              <a href="distribution-management.html">Distribution Management</a>
        </li>
                  
    <li class="none">
              <a href="issue-tracking.html">Issue Tracking</a>
        </li>
                  
    <li class="none">
              <a href="mail-lists.html">Mailing Lists</a>
        </li>
                  
    <li class="none">
              <a href="plugin-management.html">Plugin Management</a>
        </li>
                  
    <li class="none">
              <a href="license.html">Project License</a>
        </li>
                  
    <li class="none">
              <a href="modules.html">Project Modules</a>
        </li>
                  
    <li class="none">
              <a href="plugins.html">Project Plugins</a>
        </li>
                  
    <li class="none">
              <a href="project-summary.html">Project Summary</a>
        </li>
                  
    <li class="none">
              <a href="team-list.html">Project Team</a>
        </li>
                  
    <li class="none">
              <a href="source-repository.html">Source Repository</a>
        </li>
              </ul>
        </li>
              
                
              
      
            
      
              
        <li class="collapsed">
              <a href="project-reports.html">Project Reports</a>
              </li>
          </ul>
        </div>
    </div>
    <div id="content">
      <div id="contentBox">
        <h1>Background</h1>

<p>In a modular Java program or in a large Java project that has lots of dependencies, you often end up
a version of library that's different from the version used to compile the code.</p>

<p>This often results in <code>LinkageError</code>, where a method/field that was present when the code was compiled
do not exist any more in the version being loaded at the runtime.
This restriction applies to seemingly trivial safe changes, such as changing the return type of the method
to its subtype.</p>

<p>Previously, the only way to deal with this is not to remove any signatures that matter. In other words,
you count on library/module developers to be more disciplined. Over the time, Java programmers have accepted
this as a way of life, but there are some notorious offenders (Guava and ASM, I'm looking at you.) Besides,
it makes it difficult to evolve code.</p>

<p>That is where this library comes into play.</p>

<h1>What is this?</h1>

<p>This library comes with two major parts. One is the class file transformation tool, which replaces
every field/method reference/invocation by an <code>invokedynamic</code> call.</p>

<p>The second part is the runtime linker, which "links" these <code>invokedynamic</code> calls to the target. In most
cases, the referenced target exists in the runtime, so that's what you'll want to link to.</p>

<p>But because you can bring your own <code>Linker</code> implementation, this library enables you to relax the linker
resolution to be flexible and relaxed in all sorts of ways. You can convert static field access to static
method access, you can add/remove parameters to method calls, or you can even intercept a call and do
something completely different.</p>

<p>Normally, this kind of lazy resolution requires you to load class files into your own classloader, but
since this library only relies on <code>invokedynamic</code>, the resulting code can be used just like a normal jar
file and loaded into any classloader.</p>

<p>So long as you use <code>ConstantCallSite</code>, <code>invokedynamic</code> does not incur any runtime penalty on
the code that gets executed --- just one time overhead of running custom linking logic when the code is
run for the first time.</p>

<h1>How to use this library</h1>

<p>To benefit from lazy linking behavior, you must transform class files at the build time. This project
comes with a Maven plugin to simplify this. Add the following fragment in your POM to automatically
post-process class files after compilation:</p>

<pre><code>&lt;build&gt;
  &lt;plugins&gt;
    &lt;plugin&gt;
      &lt;groupId&gt;org.kohsuke.no-more-tears&lt;/groupId&gt;
      &lt;artifactId&gt;no-more-tears-maven-plugin&lt;/artifactId&gt;
      &lt;executions&gt;
        &lt;execution&gt;
          &lt;goals&gt;
            &lt;goal&gt;process&lt;/goal&gt;
          &lt;/goals&gt;
        &lt;/execution&gt;
      &lt;/executions&gt;
    &lt;/plugin&gt;
  &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>

<p>Just to be clear, the idea is to transform your code to protect yourself from libraries that break compatibility,
not to transform library code that might evolve.</p>

<p>You must also add the runtime as your dependency, because the runtime contains the code necessary to
perform linking at runtime.</p>

<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.kohsuke.no-more-tears&lt;/groupId&gt;
  &lt;artifactId&gt;no-more-tears-runtime&lt;/artifactId&gt;
  &lt;version&gt;...&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h1>Restrictions</h1>

<p>The class file transformation process rewrites every method call (instance of static, interface or not),
every field access (get or set, static or not), and every object instantiation. It even rewrites the
'super' call of the following form:</p>

<pre><code>void foo() {
    ...
    super.foo();
}
</code></pre>

<p>Unfortunately, because of the JVM byte code verification requirement, this library cannot rewrite a constructor body
where it calls this/super constructor such as this:</p>

<pre><code>class Foo extends Bar {
    Foo() {
        super(  // this super call remains statically linked
            Zot.getValue()      // this gets rewritten and gets linked at runtime
        );

        foo();  // this gets rewritten and gets linked at runtime
    }
}
</code></pre>

<h1>TODO</h1>

<p>I intend to gather common patterns for code evolution so that this library comes out-of-the-box with useful
dynamic linking rules.</p>

      </div>
    </div>
    <div id="footer">
      <div class="xright">&#169;  
          2013
    
          <a href="http://kohsuke.org/">Kohsuke Kawaguchi</a> and other contributors
          
  

  
  
  &nbsp;| Last Published: 12/14/2013
  &nbsp;| Version: 1.0
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    </div></div>
  </body>
</html>
